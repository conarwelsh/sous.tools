# History

## 2026-02-05
- **Monorepo Health Check & Housekeeping:**
    - Executed a comprehensive health check via `sous quality check` (lint, typecheck, test, build).
    - **Fixed `@sous/cli` Test & ESM Support:** 
        - Configured Jest for ESM support with `NODE_OPTIONS=--experimental-vm-modules`.
        - Resolved `jest is not defined` errors by importing from `@jest/globals`.
        - Removed stale web-app boilerplate controllers and tests from the CLI app.
    - **Fixed `@sous/api` Typechecking:**
        - Resolved missing dependencies (`@nestjs/passport`, `passport`).
        - Fixed relative import paths and added mandatory `.js` extensions for `NodeNext` compatibility.
        - Corrected `sharp` import style to support its default function export.
    - **Resolved `@sous/ui` Linting & Typing:**
        - Automated fixing of 38+ Prettier/ESLint issues.
        - Suppressed SVG `className` type errors in `@sous/docs` by using any-casted object spreads for NativeWind compatibility.
    - **Fixed `@sous/config` Test Imports:**
        - Added `moduleNameMapper` to Jest config to resolve `.js` extensions in TypeScript source files.
    - **Dependency Hydration:** Ensured all `apps/native` dependencies are correctly linked and building successfully.
    - **Result:** ACHIEVED 100% PASS RATE across all 43 turbo tasks (lint, typecheck, test, build) for all 13 packages/apps.
- **Universal Configuration & Logging:**
    - Refactored **`@sous/config`** and **`@sous/logger`** to be browser-safe, enabling their use in Tauri/Vite environments.
    - Enhanced **`@sous/config`** to properly fetch and merge **Infisical secrets** into `process.env` and the centralized config object, ensuring remote secrets override local ones.
    - Resolved `AsyncLocalStorage` and `Top-level await` issues in the logger and config packages for CJS/ESM hybrid compatibility.
- **Native-Headless Initialization:**
    - Scaffolded a new **`apps/native-headless`** application using **Tauri v2 + React + TypeScript**.
    - Configured the app to use port **1422** and integrated it with the monorepo design system and configuration.
    - **Networking Robustness:** Standardized on `127.0.0.1` for `devUrl` and Vite host to resolve IPv6 mapping issues in WSL2. Updated `TAURI_DEV_HOST` to `localhost`.
    - **Fixes:** Resolved blank window issue by simplifying the initial `App.tsx` and verifying build pipeline stability.
- **Android Dev Ops Automation:**
    - Implemented a permanent fix for WSL2-Windows Android interop issues.
    - **Automated Emulator Management:** `sous dev --android` now detects, launches, and waits for the Windows Android emulator automatically.
    - **Automated Device Selection:** The CLI now passes the preferred `emulatorName` directly to the `tauri android dev` command, eliminating interactive prompts.
    - **Automated ADB Bridge:** The CLI now automatically attempts to start the Windows ADB server with the `-a` flag (listening on all interfaces) via PowerShell, eliminating the need for manual setup on the Windows side.
    - **Path Sanitization:** The CLI now automatically strips Windows paths from the environment during Android builds to prevent directory collisions with "Android Studio".
    - **Environment Bridging:** Configured a global ADB bridge (`ADB_SERVER_SOCKET`) managed via `~/.sous/shell/zshrc`.
    - **Shell Cleanup:** Stripped redundant/duplicate Android configurations from the user's main `~/.zshrc`, consolidating all platform logic into the managed `~/.sous/shell/zshrc` file.
    - **Universal Shared Packages:** Refactored `@sous/logger` and `@sous/config` to be fully browser-safe and ESM-compatible, resolving `Dynamic require` and `AsyncLocalStorage` issues in universal environments.
    - **Centralized Logging:** Ensured all platform components append to `~/.sous/logs/combined.log` for a unified "God View" debugging experience.
- **Robust Dev Installation:**
    - Fixed **APT 404 errors** in `install-dev.sh` by automatically detecting and configuring `ports.ubuntu.com` mirrors when `arm64` is present as a foreign architecture.
    - Resolved **EACCES error** in shell customization by switching to `pnpm run sous`.
    - Automated **ZSH & Oh My Zsh** plugin configuration, ensuring `git`, `syntax-highlighting`, and `autosuggestions` are always present.
- **Project Infrastructure & Stability:**
    - **API Recovery:** Fixed `@sous/api` startup crashes by resolving database connection mismatches and explicitly binding to `0.0.0.0`.
    - **Database Sync:** Standardized local development database credentials and automated schema synchronization via `pnpm run db:push`.
    - **GUI Rendering Fixes:** Resolved "Blank Window" issues in Tauri apps under WSL2 by injecting software rendering and sandbox deactivation overrides (`WEBKIT_DISABLE_COMPOSITING_MODE=1`, etc.) into the environment.
    - **Docker Orchestration:** Integrated automatic `docker compose up -d` into the CLI orchestrator to ensure infrastructure is ready before apps attempt to connect.

## 2026-02-06 (Major Milestone: Core Suite Stabilized)

- **Platform-Wide Dev Environment Parity:**
    - Achieved full, verified functionality for all core applications: **`@sous/web`**, **`@sous/docs`**, **`@sous/api`**, **`@sous/native`**, and **`@sous/native-headless`**.
    - Verified cross-platform development workflows (Android Emulator on Windows host vs Linux Desktop GUI in WSL2).
- **Core Application Stabilization:**
    - Verified full reachability and functionality for **`@sous/web`** (port 3000), **`@sous/docs`** (port 3001), and **`@sous/api`** (port 4000).
    - Resolved API reachability issues by fixing database connection failures and ensuring explicit `0.0.0.0` binding.
    - Confirmed **`@sous/native`** correctly initializes and builds for Android via the automated CLI bridge.
- **Native-Headless Reconstruction:**
    - Re-implemented **`@sous/native-headless`** (Signage) by branching from the proven `@sous/native` codebase.
    - Standardized Linux desktop rendering fixes across all Tauri applications to resolve WSL2 blank screen issues.

## 2026-02-05
- **Identity & Multi-Tenancy (Phase 1.6):**
    - Established the core Drizzle ORM infrastructure in `@sous/api`.
    - Implemented a multi-tenant database schema with `organizations`, `users`, `locations`, and `media` tables.
    - Integrated JWT-based authentication and RBAC (User, Admin, Superadmin) in the `IAM` domain.
    - Added `sous maintenance db push` to the CLI for automated schema synchronization.
- **Media & Asset Strategy (Phase 1.7):**
    - Implemented the `Media` domain in `@sous/api` for centralized asset management.
    - Integrated **`sharp`** for mandatory grayscale and WebP optimization (ADR 028) to stay within free-tier storage limits.
    - Implemented **`SupabaseStorageService`** for tenant-isolated cloud storage.
    - Created a secure **`MediaController`** with JWT-protected upload endpoints and automatic optimization pipelines.
    - Added comprehensive storage configuration to `@sous/config`.
- **Signage MVP (Phase 2):**
    - **Presentation Engine (Phase 2.1):**
        - Established the `Presentation` domain in `@sous/api` with `templates`, `displays`, and `displayAssignments` tables.
        - Implemented **Real-time Gateway** using `socket.io` for instant content updates.
        - Integrated `socket.io-client` into `@sous/native-headless` to listen for `presentation:update` events.
        - Created a universal **`PresentationRenderer`** in `@sous/features` to handle dynamic layout rendering.
        - Implemented **System Template Seeding** in `@sous/api` to provide out-of-the-box fullscreen and grid layouts.
- **Production Readiness (Phase 1.5):**
    - **WearOS Fix:** Manually generated and configured the Gradle wrapper for `@sous/wearos`, including `gradlew`, `gradlew.bat`, and `gradle-wrapper.jar`. This resolves the immediate failure in Android Studio due to missing build scripts.
    - **Priority Realignment:** Shifted Phase 1.5 focus to prioritize stable production deployments for the core platform (`@sous/api`, `@sous/web`, `@sous/docs`) and the signage output (`@sous/native-headless`).
- **Dashboard & Dev Experience (God View):**
    - **Resolved @sous/docs "barking" issues:**
        - Fixed "Workspace Root" warning in Next.js by explicitly setting `outputFileTracingRoot`.
        - Silenced "Port 3000 in use" noise by passing the correct `PORT=3001` in the `dev.kdl` orchestrator.
        - Resolved several ESLint errors and warnings in `apps/docs` (unused variables, illegal `require` in tailwind config).
        - Cleaned up unused `react-dom-shim.js` logic and unified React 19 compatibility shims.
    - Added `[c]` keyboard shortcut to `sous dev` to clear logs for the currently active panel (Services, Combined, Terminal, or Gemini).
- **Branding Identity & Lab Evolution:**
    - Upgraded **`@sous/docs`** to use the official **`Wordmark`** component, eliminating hardcoded logo text.
    - Enhanced the **Branding Lab** with interactive controls for `variant`, `size`, and `wordmark` props.
    - Implemented a list of predefined wordmark options (`sous.api`, `sous.docs`, `sous.kds`, etc.) to ensure cross-platform brand consistency.
    - Improved **`NeonLogo`** visuals with sophisticated SVG filters (glows) and robust wordmark rendering.
    - Standardized wordmark rendering across all variants (**Neon**, **Plate**, **Link**, **Dot**) to follow the brand identity (Main white, .TLD in brand color, all caps).
    - Unified monorepo versioning to **v0.0.0** and ensured UI components reflect this state.
    - Fixed Next.js 16 Turbopack compatibility issue in `@sous/docs` by explicitly enabling the Webpack compiler for custom alias support.
- **Universal Design System (Phase 1.3):**
    - Implemented standardized `Button`, `Input`, and `Card` atoms in `@sous/ui` using universal styling (NativeWind v4).
    - Created an interactive "Atomic Playground" in `@sous/docs` for CDD verification.
- **Native Bridge & Offline Safety (Phase 1.4):**
    - Implemented `NativeBridge` with persistent `OfflineAction` queue.
    - Integrated SQLite via `@tauri-apps/plugin-sql` for native environments with a `localStorage` fallback for the web.
- **Infrastructure Dashboard:** Integrated real-time system metrics (CPU, Memory, Uptime) into the `sous dev` TUI.
- **Documentation Hub UI Overhaul:**
    - Implemented a professional, responsive layout for `@sous/docs` with a collapsible desktop sidebar and animated mobile menu.
    - Designed a structured navigation system that automatically groups ADRs, Specifications, and READMEs.
    - Integrated high-fidelity typography and custom prose styling using the project's brand fonts (Outfit/Inter).
    - Optimized `@sous/features` to use web-native components for the Knowledge Base to resolve bleeding-edge Next.js 16/Turbopack compatibility issues with universal `react-native` aliases.
- **Phase 1.2 Accomplishments:**
    - **Documentation Hub:** Implemented `@sous/docs` with a persistent Knowledge Base that aggregates ADRs, Specs, and READMEs. Refactored `@sous/features` build system to support split client/server entries for Next.js compatibility.
    - **CLI DDD Refactoring:** Reorganized `@sous/cli` into strategic umbrellas (`dev`, `env`, `quality`, `maintenance`).
    - **Robust Dev Orchestrator:** Implemented an interactive React Ink TUI for `sous dev`, replacing static logging with a real-time process dashboard.
    - **ZSH Customization:** Implemented `sous dev install shell` which adds brand-aligned prompts, infrastructure health indicators, and productivity aliases (`sous`, `sd`, `sl`, `c`, `ls`, etc.) to the user's terminal.
- Enforced **Mandate 15: The Shell Pattern** by moving strategic umbrellas from `@sous/web` to the shared **`@sous/features`** package, ensuring absolute logic reuse between platforms.
- Completed **Phase 1.1** of the rollout plan.
- Migrated `@sous/api` and `@sous/web` to the **Nested DDD** folder structure (moving core logic to `domains/` and `features/`).
- Configured Traefik in `docker-compose.yml` as a reverse proxy, including a dynamic bridge to the Raspberry Pi (`rpi.sous.local`).
- Created **ADR 040: CI/CD Strategy for Native Binaries** to utilize self-hosted GitHub runners for Windows and ARM64 builds.
- Refined **ADR 039: CLI-Driven ZSH Customization** to include a robust set of productivity aliases (`sous`, `c`, `ls`, `sd`, `sl`, etc.).
- Comprehensive README overhaul: Created/Updated `README.md` for all 9 apps and 8 packages, adhering to **Mandate 6** (Responsibilities, Setup, Tech Stack, ADR links).
- Rewrote `@sous/cli` README.md to accurately reflect the tool's capabilities and document the upcoming shell customization features.
- Created **ADR 039: CLI-Driven ZSH Customization** to improve Developer Experience with brand-aligned prompts and infrastructure status indicators.
- Updated `phase-rollout-plan.md` to include ZSH customization in Phase 1.2.
- Refactored `scripts/dev-orchestrator.ts` to use absolute `pnpm` paths and avoid `shell: true` issues, fixing `ENOENT` errors during app startup.
- Updated root `.idea` configuration to use `#GRADLE_LOCAL_JAVA_HOME` for better WSL compatibility in Android Studio.
- Switched to `includeBuild` in the root `settings.gradle.kts` for Tauri-based projects.
- Fixed a Gradle sync error in the `apps/native` subproject by removing the redundant `allprojects` repository block.
- Fixed Android Studio "Invalid Gradle JDK" warnings by switching to `#PROJECT_SDK` and defining a clean `17` JavaSDK in `.idea/misc.xml`.
- Configured monorepo for "Single Window" Android Studio support by adding root `settings.gradle.kts` and `build.gradle.kts`.
- Updated `dev-device-installation.md` with physical device setup and monorepo IDE instructions.
- Fixed `@sous/config` package by implementing a proper build step with `tsup`. This resolved a `SyntaxError: Named export 'localConfig' not found` in Vite.
- Improved `scripts/install-dev.sh` to support ZSH, use correct Android SDK paths, and export `TAURI_DEV_HOST`.
- Fixed missing `unzip` dependency and added automatic ARM64 `apt` source fixing in `scripts/install-dev.sh`.
- Verified `@sous/docs` and `@sous/web` functionality.
- Configured development environment with non-conflicting ports:
  - API: 4000
  - Web: 3000
  - Docs: 3001
  - Native Apps (Vite): 1421-1424
- Fixed `@sous/native*` application identifiers in `tauri.conf.json` to avoid reserved keywords (e.g., changed `com.conar.native` to `com.sous.nativeapp`).
- Successfully started all core services and native app dev servers.
- Verified all services are responding via curl.
- Updated ADR 004: Added mandate for strict `"use client"` directive usage (DOM/Browser API interaction only).
- Added Mandate 13: Strict `"use client"` usage (only when DOM/Browser APIs are required).
- Updated ADR 005: Refined domain boundaries, introduced the **Intelligence** domain for asynchronous costing, and renamed "Catalog" to "Procurement" and "IoT" to "Hardware".
- Converted `@sous/ui` to Universal Architecture using **NativeWind v4**, **React Native Web**, and **React Native Reusables** pattern.
- **Branding Migration:**
    - Migrated **Neon Lettermark/Wordmark** from the legacy project.
    - Converted SVG branding components to **`react-native-svg`** for universal cross-platform support.
    - Added 3 new scalability-focused lettermark variants: **`plate`**, **`link`**, and **`dot`**.
    - Updated **`brand-identity.md`** with professional `oklch` theme tokens.
    - Established **.gemini/specs/005-documentation-hub.md** for a pixel-perfect Branding Lab with persistence and a CDD playground.
    - Expanded **ADR 006** with a comprehensive baseline of required UI atoms (Button, Input, Card, Dialog, etc.).
- **Architectural Refinement:**
    - Re-indexed all ADRs (001-030) for proper logical/dependency ordering.
    - Merged **Admin Domains** (SuperAdmin + TenantAdmin) into ADR 021.
    - Merged **Visual Domains** (Layouts + Displays + Labels) into ADR 022 (Presentation).
    - Created **ADR 028: Media Management Strategy** (Supabase + Cloudinary).
    - Created **ADR 029: Data Retention & Pruning Strategy** (Free-tier row management).
    - Updated **ADR 011: Native Bridge** with **Offline Safety Mode** (Local SQLite).
    - Refined ADR 022: Defined the two-tier layout system (Structural Templates vs. Specialized Content Assignment).
    - **Final Strategic Refinements:**
        - Differentiated **Intelligence** (Real-time) vs. **Accounting** (Historical) domains.
        - Created **ADR 032: I18n Strategy** (Type-safe, code-split translations).
        - Created **ADR 033: Testing Strategy** (HITL simulation + Universal UI testing).
- Created ADR 034: Real-time Throttling (60s batching for free-tier sustainability).
- Created **ADR 035: Docker Infrastructure Strategy** (Local Cloud Mocks: Postgres, Redis, MailDev, Minio).
- Created **ADR 036: Shared Features & Shell Pattern Strategy** (Maximizing reuse via `@sous/features`).
- Created **ADR 037: Robust Dev Orchestrator Strategy** (Implementing custom React Ink TUI).
- Created **ADR 038: CLI Infrastructure Dashboard Strategy** (Animated TUI for platform metrics).
- Established **.gemini/specs/004-cli-infra-dashboard.md** for the real-time reporting tool.
- Integrated **Docker Compose management** (Status, Start/Stop, Logs) into the Dev Orchestrator plan.
- Added **RPi Edge Integration** to Dev Orchestrator (SSH log tailing, one-click Sync+Start).
- Expanded **`sous maintenance`** brainstorming with `dead-code`, `unused-packages`, and `unused-css` commands.
- Added **`ubuntu-sandbox` image** to ADR 035 for ephemeral testing of installation scripts.
- Added **Mandate 17: Build Artifact Exclusion** (Ensuring @.gemini is excluded from production).
- Added **Mandate 18: Development Branch Isolation** (No cloud deployments for `development`).
- Configured **Husky** to skip all checks (commit and push) when on the `development` branch.
- Scaffolded **`@sous/features`** package for domain-specific "Organisms" and logic.
- Added **Mandate 15: The Shell Pattern** (Apps are thin shells; logic lives in `@sous/features`).
- Added **Mandate 16: CLI Command Aggregation** (All `package.json` scripts must be aggregated into `@sous/cli`).
- **Phase Rollout Plan Realignment:**
    - Prioritized "Phase 1.5: Production Readiness" to ensure all native apps build/deploy successfully.
    - Elevated "Phase 2: Signage MVP" to high priority for immediate restaurant usage.
    - Reorganized Culinary domains to focus on "Data Entry" before "Intelligence."
    - Deprioritized KDS and POS to the final phase.
- Established **.gemini/docs/brand-identity.md** for visual and stylistic principles.
        - Updated **ADR 028** with strict Grayscale/WebP mandate for Invoice storage.
        - Renamed ADR 030 to **ADR 031: Android Dev Workflow**.
    - Established `.gemini/specs/` directory for implementation planning.
## 2026-02-03
- Initial scaffolding of the project structure.
- Created apps: web, api, cli.
- Created packages: client-sdk, config, eslint-config, logger, typescript-config, ui.
- Established mandates in .gemini/GEMINI.md.
- Switched package manager from `npm` to `pnpm`.
- Created ADR 002: Centralized Configuration Strategy (Infisical + Zod).
- Created ADR 003: Centralized Logger Strategy (Pino + Better Stack).
- Created ADR 004: Domain-Driven Design & Frontend Architecture.
- Created ADR 005: Platform Domains & Multi-Tenancy Strategy.
- Created ADR 006: Universal UI Component Strategy (React Native Web + NativeWind).
- Created ADR 007: Deployment & Environment Strategy.
- Created ADR 008: CLI Orchestrator Strategy (@sous/cli).
- Created ADR 009: Security, Authentication, and Authorization Strategy.
- Added Global Mandate: All infrastructure must operate within service **Free Tiers**.
- Created ADR 010: Backend API Architecture & Communication Strategy (REST, GQL, WS, BullMQ, Resend, Cron, Drizzle ORM).
- Selected **Drizzle ORM** as the primary data access layer for the platform.
- Created ADR 011: Native Bridge Strategy (@sous/native-bridge - BLE Gateway, Offline Caching).
- Created ADR 012: Headless Kiosk Strategy (@sous/native-headless).
- Created ADR 013: Kitchen Display System (KDS) Strategy (@sous/native-kds).
- Created ADR 014: Point of Sale (POS) Strategy (@sous/native-pos).
- Created ADR 015: Universal Platform Application Strategy (@sous/web & @sous/native).
- Created ADR 016: Documentation Platform & Branding Lab (@sous/docs).
- Created ADR 017: Hardware Domain Strategy (Supersedes/Refines IoT Domain).
- Created ADR 018: Recipes Domain Strategy (AI Ingestion, Advanced Scaling).
- Created ADR 019: Invoices Domain Strategy (AI Extraction, Price History).
- Created ADR 020: Ingredients Domain Strategy (Market Intelligence, Price Wars).
- Created ADR 021: SuperAdmin Domain Strategy (Platform Oversight, Tenant Management).
- Created ADR 022: Tenant Admin Domain Strategy (Organization & Location Management).
- Created ADR 023: Layout Manager Domain Strategy (Visual WYSIWYG Editor).
- Created ADR 024: Displays Domain Strategy (Content Assignment & Orchestration).
- Created ADR 025: Labels Domain Strategy (Visual Label Design & Printing).
- Created ADR 026: Accounting & Financial Intelligence Domain Strategy.
- Created ADR 027: Third-Party Integrations Strategy (Driver/Adapter Pattern).
- Created ADR 028: Virtual Inventory & Order Management Strategy.
- Created ADR 029: Order Manager Strategy (Vendor Optimization & Reconciliation).
- Created ADR 030: Wear OS Application Strategy (@sous/wearos).
- Defined Phased Rollout Plan in `.gemini/phased-rollout.md`.
- Added Mandate 7: Server-Side Data Fetching (Next.js Server Components & Actions).
- Added Mandate 8: Local Development Branch (Mandatory `development` branch for local work).
- Added Mandate 6: Automated Documentation (READMEs) for all packages and apps.
- Implemented `sous logs tail` and `sous logs wipe` commands in `@sous/cli`.
- Fixed `@sous/config` and `@sous/cli` Infisical integration to use SDK v4.
- Added `sous config add` command for upserting secrets.
- Refactored `@sous/cli` folder structure to follow DDD principles (grouped by command in `src/commands/`).
- Added Mandate 11: Feature-Based Folder Structure (Mandatory grouping by feature/domain).
- Stabilized Build: Enabled Webpack for `@sous/cli` to handle monorepo path aliases correctly.
- Verified `sous dev` and `sous logs tail` functionality.
- Implemented `sous test` (runs turbo test) and `sous check` (runs lint, typecheck, test, build).
- Implemented `sous housekeep` to deep clean build artifacts from the monorepo root.
- Verified `@sous/docs` and `@sous/web` load correctly in the development environment.
- Updated `sous dev` plan to include native apps (Native, Headless, KDS, POS) with focus on Android emulator.
